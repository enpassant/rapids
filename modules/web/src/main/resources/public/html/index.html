<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta http-equiv="edit-Type" edit="text/html; charset=utf-8" />
    </head>
    <body>

        <div class="logo">
            Logo
        </div>
        <div class="login">
        </div>
        <div id="messages">
            Messages
        </div>
        <div id="view"></div>

    </body>
        <style>
            body {
                margin: 0px;
                padding: 0px;
                display: flex;
                flex-flow: row wrap;
            }

            textarea {
              width: 400px;
              height: 250px;
            }

            .logo, .login, #messages, #view {
                flex: 1 100%;
            }

            @media all and (min-width: 600px) {
              .logo { flex: 1 80%; }
              .login { flex: 1 20%; }
            }

            @media all and (min-width: 900px) {
              .logo { flex: 1 70%; order: 1; }
              .login { flex: 1 30%; order: 2; }
              #view { flex: 2 70%; order: 3; }
              #messages { flex: 1 30%; order: 4; }
            }

            .logo {
                background: #d8d8ff;
            }

            .login {
                background: #6060ff;
            }

            #login-data {
                display: none;
                background: #ffffff;
                border: 1px solid #808080;
            }

            .login > a {
                width: 100%;
                cursor: pointer;
            }

            .login > * {
                text-align: center;
                width: 100%;
            }

            #login-data > div > label {
                flex: 1 100%;
                display: block;
                text-align: center;
                font-weight: 700;
                font-size: 12px;
            }
        </style>

        <script type="text/javascript">
            (function() {
                var clientId = Math.floor(Math.random() * (10 - 1) + 1)
                console.log("WebSocket clientId: " + clientId);

                var token = undefined;

                function WebSocketTest()
                {
                    if ("WebSocket" in window)
                    {
                        console.log("WebSocket is supported by your Browser!");

                        var self = this;

                        var open = function() {
                            console.log("Connection is opened...");
                            self.ws = new WebSocket("ws://localhost:8080/updates/"
                                + clientId);

                            /*
                            self.ws.onopen = function()
                            {
                                ws.send("Message to send");
                                console.log("Message is sent...");
                            };
                            */

                            self.ws.onmessage = function (evt)
                            {
                                var msg = JSON.parse(evt.data).value;
                                var br = document.createElement("br");
                                byId("messages").appendChild(br);
                                var textnode = document.createTextNode(msg);
                                byId("messages").appendChild(textnode);
                            };

                            self.ws.onclose = function()
                            {
                                console.log("Connection is closed...");
                                open();
                            };
                        }

                        open();
                    }

                    else
                    {
                        // The browser doesn't support WebSocket
                        console.log("WebSocket NOT supported by your Browser!");
                    }
                }

                window.ajaxGet = function(url) {
                    return new Promise(function(resolve, reject) {
                        let req = new XMLHttpRequest();
                        req.open("GET", url);
                        req.onload = function() {
                            if (req.status === 200) {
                                resolve(req.response);
                            } else {
                                reject(new Error(req.statusText));
                            }
                        };

                        req.onerror = function() {
                            reject(new Error("Network error"));
                        };

                        req.send();
                    });
                }

                window.ajaxPost = function(url, data) {
                    return new Promise(function(resolve, reject) {
                        let req = new XMLHttpRequest();
                        req.open("POST", url);
                        req.setRequestHeader("Content-type", "application/json");
                        const payload = extractPayload(token);
                        if (typeof payload !== "undefined") {
                            const now = new Date().getTime() / 1000;
                            if (now <= payload.exp) {
                                req.setRequestHeader("Authorization", token);
                            } else {
                                token = undefined;
                                if (typeof(Storage) !== "undefined") {
                                    localStorage.removeItem("token");
                                }
                            }
                        }
                        req.onload = function() {
                            if (req.status === 200) {
                                var t = req.getResponseHeader("X-Token");
                                if (typeof t !== "undefined") {
                                    token = t;
                                    if (typeof(Storage) !== "undefined") {
                                        localStorage.token = token;
                                    }
                                }
                                resolve(req.response);
                            } else {
                                reject(new Error(req.statusText));
                            }
                        };

                        req.onerror = function() {
                            reject(new Error("Network error"));
                        };

                        req.send(JSON.stringify(data));
                    });
                }

                function extractPayload() {
                    if (typeof token !== "undefined") {
                        const parts = token.split('.');
                        if (parts.length === 3) {
                            return JSON.parse(atob(parts[1]));
                        }
                    }
                    return undefined;
                }

                function addScripts(el) {
                    var scripts = el.getElementsByTagName("script");
                    var form = el.firstElementChild;
                    for (i = 0; i < scripts.length; i++) {
                        var evalFn = function() {
                            return eval(scripts[i].innerHTML);
                        };
                        evalFn.call(form);
                    }
                }

                var el = null;
                function router () {
                    el = el || byId('view');
                    var url = location.hash.slice(1) || '/blog';

                    if (el && url) {
                        ajaxGet(url)
                            .then(function(data) {
                                el.innerHTML =
                                    data.replace(/(\s+href=")\//g, "$1#/");
                                addScripts(el);
                                var pos = url.indexOf("#");
                                if (pos >= 0) {
                                    var goal = url.substring(pos + 1);
                                    byId(goal).scrollIntoView();
                                }
                            })
                            .catch(function(e) {
                                el.innerHTML = e;
                            });
                    }
                }

                window.byId = function(id) {
                    return document.getElementById(id);
                }

                window.isHidden = function(el) {
                    var style = window.getComputedStyle(el);
                    return (style.display === 'none')
                }

                if (typeof(Storage) !== "undefined") {
                    token = localStorage.token;
                }

                window.addEventListener('hashchange', router);
                window.addEventListener('load', router);
                <!--var webSocket = WebSocketTest();-->
            })();
        </script>

</html>
