<div id="monitor">
</div>

<script type="text/javascript">
    const { render, Component, createElement } = Inferno;

    function Bar(width, y) {
        return [
            createElement('g', { "className": "bar" },
                createElement(
                    'rect',
                    { "width": width, "height": 8, "y": y }),
                createElement(
                    'text',
                    { "x": width + 2, "height": 8, "y": y + 5,
                        "font-size": 7 },
                    width))
        ];
    }

    function MsStat(props) {
        const bars = [
            Bar(props.stat.min, 40),
            Bar(props.stat.avg, 50),
            Bar(props.stat.max, 60)
        ];
        return createElement('svg',
            { "className": "stat", "width": 150, "height": 100 },
            [
                createElement(
                    'text',
                    { "x": props.stat.reqNum + 1, "y": 15 },
                    props.key),
                createElement(
                    'text',
                    { "x": props.stat.reqNum + 1, "y": 35 },
                    props.stat.reqNum + "/" + props.stat.failed)
            ].concat(bars)
        );
    }

    function Microservices(stats) {
        const msStats = Object.keys(stats).map(function(objectKey, index) {
            var value = {
                "key": objectKey,
                "stat": stats[objectKey]
            };
            console.log(value);
            return MsStat(value);
        });
        return createElement('div', null, msStats);
    }

    (function() {
        function WSMonitor()
        {
            if ("WebSocket" in window)
            {
                var self = this;

                var open = function() {
                    console.log("Connection is opened...");
                    self.ws = new WebSocket("ws://localhost:8080/wsmonitor");

                    /*
                    self.ws.onopen = function()
                    {
                        ws.send("Message to send");
                        console.log("Message is sent...");
                    };
                    */

                    self.ws.onmessage = function (evt)
                    {
                        var received_msg = evt.data;
                        console.log("1 Message is received:\n" + received_msg);
                        const stats = JSON.parse(evt.data);
                        Inferno.render(Microservices(stats), document.getElementById('monitor'));
                    };

                    self.ws.onclose = function()
                    {
                        console.log("Connection is closed...");
                        open();
                    };
                }

                open();
            } else {
                console.log("WebSocket NOT supported by your Browser!");
            }
        }
        var webSocket = WSMonitor();
    })();
</script>
